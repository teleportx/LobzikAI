<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Markdown Preview ‚Äî Dark Theme</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
  <style>
    :root{
      --bg:#0b0e14;
      --panel:#111520;
      --text:#e6e6e6;
      --muted:#9aa4b2;
      --brand:#7aa2f7;
      --border:#23283a;
      --code-bg:#0d1117;
      --radius:14px;
      --font-ui:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(800px 600px at 10% -10%, rgba(122,162,247,.09), transparent) no-repeat fixed,
                  var(--bg);
      color:var(--text);
      font-family:var(--font-ui);
      line-height:1.6;
      padding:28px
    }
    .card{
      max-width:1100px;
      margin:0 auto;
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      padding:22px
    }
    .preview{padding:8px 2px 18px 2px}
    .preview h1{font-size:2rem;margin-top:1rem}
    .preview h2{font-size:1.5rem}
    .preview p{margin:.6em 0}
    .preview a{color:var(--brand)}
    .preview blockquote{border-left:3px solid var(--brand);padding:.5em 1em;background:rgba(122,162,247,.03);border-radius:8px}
    .preview code{font-family:ui-monospace,Menlo,Monaco,Consolas,monospace;padding:.12em .35em;border-radius:6px;background:rgba(255,255,255,.04)}
    .preview pre{background:var(--code-bg);padding:12px;border-radius:10px;border:1px solid var(--border);overflow:auto}
    .preview table{width:100%;border-collapse:collapse;margin:1em 0}
    .preview th,.preview td{border:1px solid var(--border);padding:.5em .6em}
    .preview img{max-width:100%;border-radius:8px;border:1px solid var(--border)}

    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    #editor-controls {
      display: none;
      gap: .6rem;
      margin-bottom: 1rem;
    }
    #editor-controls button {
      padding: .45em 1em;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background .2s ease, opacity .2s ease;
    }
    #editBtn, #saveBtn {
      background: var(--brand);
      color: #fff;
    }
    #editBtn.cancel {
      background: #555; /* —Å–µ—Ä—ã–π –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ */
    }
    #editor-controls button:hover { opacity:.85; }

    /* –†–µ–¥–∞–∫—Ç–æ—Ä */
    .editor-box {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0;
      margin-bottom: 1rem;
    }
    .editor-box textarea {
      width: 100%;
      min-height: calc(100vh - 240px);
      border: none;
      outline: none;
      resize: vertical;
      background: transparent;
      color: var(--text);
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 15px;
      line-height: 1.5;
      padding: 12px;
    }

    /* quiz */
    #quiz {margin-top:2rem;padding-top:1rem;border-top:1px solid var(--border)}
    .blur {filter: blur(5px); cursor:pointer}
    .blur.revealed {filter:none}

    /* ask AI */
    #ask-ai {margin-top:2rem;padding-top:1rem;border-top:1px solid var(--border)}
    #ask-ai textarea{width:100%;padding:.6em;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--text);margin-bottom:.6em}
    #ask-ai button{padding:.5em 1em;border:none;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
    #ask-ai button:hover{opacity:.9}

    @media (max-width:720px){
      body{padding:14px}
      .card{padding:14px}
      .preview h1{font-size:1.4rem}
      .editor-box textarea{min-height:50vh}
    }
  </style>
</head>
<body>
  <div class="card" role="main">
    <div id="editor-controls">
      <button id="editBtn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="saveBtn" style="display:none;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <article id="preview" class="preview" aria-live="polite"></article>

    <!-- –ú–∏–Ω–∏-—Ç–µ—Å—Ç -->
    <section id="quiz">
      <h2>–ü—Ä–æ–≤–µ—Ä—å —Å–µ–±—è</h2>
      <div class="qa">
        <p><b>–í–æ–ø—Ä–æ—Å:</b> –ß—Ç–æ —Ç–∞–∫–æ–µ –∑–∞–º—ã–∫–∞–Ω–∏–µ –≤ JS?</p>
        <p><b>–û—Ç–≤–µ—Ç:</b> <span class="blur">–ó–∞–º—ã–∫–∞–Ω–∏–µ ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Å–≤–æ—ë –ª–µ–∫—Å–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –Ω–µ–≥–æ.</span></p>
      </div>
    </section>

    <!-- –í–æ–ø—Ä–æ—Å –∫ AI -->
    <section id="ask-ai">
      <h2>–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å AI</h2>
      <textarea id="ai-question" rows="3" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å..."></textarea>
      <button id="askBtn">ü§ñ –°–ø—Ä–æ—Å–∏—Ç—å</button>
      <div id="ai-answer" class="muted"></div>
    </section>
  </div>

  <script>
    let MARKDOWN = ``;
    const lecture_id = '{{lecture_id}}';
    const apikey = 'test';
    const preview = document.getElementById('preview');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const controls = document.getElementById('editor-controls');

    async function get_text() {
      let res = await fetch(`/lecture/${lecture_id}/data`);
      const data = await res.json();
      MARKDOWN = data['summarized_text'];
    }

    marked.setOptions({
      gfm: true, breaks: true, headerIds: true, mangle: false, smartLists: true,
      highlight: (code, lang) => {
        try { if(lang && hljs.getLanguage(lang)) return hljs.highlight(code, {language:lang}).value } catch(_) {}
        try { return hljs.highlightAuto(code).value } catch(_) { return code }
      }
    });

    function render(md){
      const html = marked.parse(md);
      const clean = DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
      preview.innerHTML = clean;
      preview.querySelectorAll('a[href]').forEach(a => { a.target = '_blank'; a.rel = 'noopener noreferrer nofollow' });
      preview.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    }

    get_text().then(() => render(MARKDOWN));

    if (apikey) controls.style.display = 'flex';

    let editing = false;
    let editorBox, textarea;

    editBtn.onclick = () => {
      if (!editing) {
        // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        editorBox = document.createElement('div');
        editorBox.className = 'editor-box';
        textarea = document.createElement('textarea');
        textarea.value = MARKDOWN;
        editorBox.appendChild(textarea);

        preview.replaceWith(editorBox);

        editBtn.textContent = "‚úñ –û—Ç–º–µ–Ω–∞";
        editBtn.classList.add("cancel"); // —Å–µ—Ä—ã–π
        saveBtn.style.display = "inline-block";

        textarea.focus();
        editing = true;
      } else {
        // –û—Ç–º–µ–Ω–∞
        editorBox.replaceWith(preview);
        editBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        editBtn.classList.remove("cancel");
        saveBtn.style.display = "none";
        editing = false;
      }
    };

    saveBtn.onclick = async () => {
      if (editing) {
        const newMd = textarea.value;
        let res = await fetch(`/lecture/${lecture_id}/edit`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apikey}` },
          body: JSON.stringify({ summarized_text: newMd })
        });
        if (res.ok) {
          MARKDOWN = newMd;
          render(MARKDOWN);
          editorBox.replaceWith(preview);
          editBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
          editBtn.classList.remove("cancel");
          saveBtn.style.display = "none";
          editing = false;
        }
      }
    };

    document.addEventListener('click', e => {
      if (e.target.classList.contains('blur')) {
        e.target.classList.toggle('revealed');
      }
    });

    document.getElementById('askBtn').onclick = async () => {
      const q = document.getElementById('ai-question').value;
      document.getElementById('ai-answer').textContent = "‚è≥ –î—É–º–∞—é...";
      const res = await fetch(`/lecture/${lecture_id}/ask`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: q })
      });
      const data = await res.json();
      document.getElementById('ai-answer').textContent = data.answer;
    };

    window.setMarkdown = (md) => { render(md); };
    window.getHtml = () => preview.innerHTML;
  </script>
</body>
</html>
